(function(){'use strict';const cfg={shared:{radiusX:.38,radiusY:.2,baseSpeed:.15}};const stage=document.querySelector('.orbit-stage');if(!stage)return;const items=Array.from(document.querySelectorAll('.orbit-item'));if(!items.length)return;const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);const state={baseAngle:0,rotationDirection:1,stageSize:0,isDragging:false,lastPointerAngle:0,spinVelocity:0,startX:0,startY:0,totalDistance:0,startTime:0,clickedItem:null};const DRAG_THRESHOLD=isMobile?15:10;const TAP_TIME_THRESHOLD=300;const CLICK_VELOCITY_THRESHOLD=.02;const DRAG_MULT=.9;const MAX_SPIN_VELOCITY=.12;const MAX_ROTATION_SPEED=.08;const INERTIA_DECAY=.98;const MIN_VELOCITY=.0001;let smoothedVelocity=0;let lastTimestamp=0;let precalcPositions=items.map(()=>({x:0,y:0,scale:1,opacity:1,zIndex:50}));function measureStage(){state.stageSize=Math.min(stage.offsetWidth,stage.offsetHeight)}function getPointerAngle(evt){const rect=stage.getBoundingClientRect();const cx=rect.left+rect.width*.5;const cy=rect.top+rect.height*.5;const px=evt.touches?evt.touches[0].clientX:evt.clientX;const py=evt.touches?evt.touches[0].clientY:evt.clientY;return Math.atan2(py-cy,px-cx)}function getPointerCoords(evt){return{x:evt.touches?evt.touches[0].clientX:evt.clientX,y:evt.touches?evt.touches[0].clientY:evt.clientY}}function calculatePositions(){const radiusX=cfg.shared.radiusX*state.stageSize;const radiusY=cfg.shared.radiusY*state.stageSize;for(let i=0;i<items.length;i++){const offset=parseFloat(items[i].dataset.offset)||0;const sizeMultiplier=parseFloat(items[i].dataset.size)||1;const angle=state.baseAngle+offset;const cosAngle=Math.cos(angle);const sinAngle=Math.sin(angle);const x=cosAngle*radiusX;const verticalStretch=sinAngle>0?1+Math.pow(sinAngle,1.5)*.1:1+sinAngle*.28;const y=sinAngle*radiusY*verticalStretch;const depthFactor=sinAngle*.7+Math.abs(cosAngle)*.3;const baseScale=(.45+depthFactor*.45)*2;const scale=baseScale*sizeMultiplier;const opacity=.25+(depthFactor*.5+.5)*.75;const zIndex=sinAngle<0?(49-((sinAngle-0)/-1)*48)|0:(51+((sinAngle-0)/1)*49)|0;precalcPositions[i].x=x;precalcPositions[i].y=y;precalcPositions[i].scale=scale;precalcPositions[i].opacity=opacity;precalcPositions[i].zIndex=zIndex}}function renderItems(){for(let i=0;i<items.length;i++){const item=items[i];const pos=precalcPositions[i];item.style.transform='translate3d(calc(-50% + '+pos.x.toFixed(1)+'px), calc(-50% + '+pos.y.toFixed(1)+'px), 0) scale('+pos.scale.toFixed(3)+')';item.style.opacity=pos.opacity.toFixed(3);item.style.zIndex=pos.zIndex}}let physicsAccumulator=0;const PHYSICS_STEP=16.67;function animate(timestamp){const frameTime=lastTimestamp?Math.min(timestamp-lastTimestamp,100):16.67;lastTimestamp=timestamp;physicsAccumulator+=frameTime;let steps=0;while(physicsAccumulator>=PHYSICS_STEP&&steps<3){updatePhysics(1);physicsAccumulator-=PHYSICS_STEP;steps++}if(physicsAccumulator>PHYSICS_STEP*3){physicsAccumulator=0}calculatePositions();renderItems();requestAnimationFrame(animate)}function updatePhysics(dt){if(!state.isDragging){const sinAngle=Math.sin(state.baseAngle);const speedMod=sinAngle>0?1-sinAngle*.35:1-sinAngle*.55;const autoRot=state.rotationDirection*cfg.shared.baseSpeed*.01*dt*speedMod;state.baseAngle+=autoRot>MAX_ROTATION_SPEED?MAX_ROTATION_SPEED:(autoRot<-MAX_ROTATION_SPEED?-MAX_ROTATION_SPEED:autoRot);if(Math.abs(smoothedVelocity)>MIN_VELOCITY){const applied=smoothedVelocity*dt;state.baseAngle+=applied>MAX_ROTATION_SPEED?MAX_ROTATION_SPEED:(applied<-MAX_ROTATION_SPEED?-MAX_ROTATION_SPEED:applied);smoothedVelocity*=INERTIA_DECAY;if(Math.abs(smoothedVelocity)>.001){state.rotationDirection=smoothedVelocity>0?1:-1}}else{smoothedVelocity=0}}}function handleDragStart(evt){const coords=getPointerCoords(evt);state.isDragging=true;state.lastPointerAngle=getPointerAngle(evt);smoothedVelocity=0;state.startX=coords.x;state.startY=coords.y;state.totalDistance=0;state.startTime=Date.now();state.clickedItem=evt.target.closest('.orbit-item');items[0].classList.add('is-dragging');if(items[1])items[1].classList.add('is-dragging');evt.preventDefault()}function handleDragMove(evt){if(!state.isDragging)return;const coords=getPointerCoords(evt);const currentAngle=getPointerAngle(evt);const dx=coords.x-state.startX;const dy=coords.y-state.startY;state.totalDistance+=Math.sqrt(dx*dx+dy*dy);state.startX=coords.x;state.startY=coords.y;let angleDelta=currentAngle-state.lastPointerAngle;if(angleDelta>Math.PI)angleDelta-=6.28318;if(angleDelta<-Math.PI)angleDelta+=6.28318;const cappedDelta=angleDelta>.15?.15:(angleDelta<-.15?-.15:angleDelta);state.baseAngle+=cappedDelta*DRAG_MULT;smoothedVelocity=cappedDelta*DRAG_MULT;if(smoothedVelocity>MAX_SPIN_VELOCITY)smoothedVelocity=MAX_SPIN_VELOCITY;if(smoothedVelocity<-MAX_SPIN_VELOCITY)smoothedVelocity=-MAX_SPIN_VELOCITY;if(angleDelta!==0){state.rotationDirection=angleDelta>0?1:-1}state.lastPointerAngle=currentAngle;evt.preventDefault()}function handleDragEnd(evt){const duration=Date.now()-state.startTime;const wasDragging=state.totalDistance>DRAG_THRESHOLD;const wasQuickTap=duration<TAP_TIME_THRESHOLD;const isStillEnough=Math.abs(smoothedVelocity)<CLICK_VELOCITY_THRESHOLD;state.isDragging=false;items[0].classList.remove('is-dragging');if(items[1])items[1].classList.remove('is-dragging');const shouldAllowClick=!wasDragging&&wasQuickTap&&isStillEnough;if(!shouldAllowClick){evt.preventDefault();if(wasDragging){smoothedVelocity*=(isMobile?1.5:1.2);if(smoothedVelocity>MAX_SPIN_VELOCITY)smoothedVelocity=MAX_SPIN_VELOCITY;if(smoothedVelocity<-MAX_SPIN_VELOCITY)smoothedVelocity=-MAX_SPIN_VELOCITY}}state.clickedItem=null}items.forEach(item=>{item.addEventListener('click',(evt)=>{if(state.totalDistance>DRAG_THRESHOLD){evt.preventDefault()}})});stage.addEventListener('mousedown',handleDragStart);stage.addEventListener('touchstart',handleDragStart,{passive:false});window.addEventListener('mousemove',handleDragMove);window.addEventListener('touchmove',handleDragMove,{passive:false});window.addEventListener('mouseup',handleDragEnd);window.addEventListener('touchend',handleDragEnd);let resizeTimeout;new ResizeObserver(()=>{clearTimeout(resizeTimeout);resizeTimeout=setTimeout(()=>{measureStage();calculatePositions();renderItems()},150)}).observe(stage);document.addEventListener('visibilitychange',()=>{if(!document.hidden){lastTimestamp=0;physicsAccumulator=0}});measureStage();items[0].style.left='50%';items[0].style.top='50%';if(items[1]){items[1].style.left='50%';items[1].style.top='50%'}calculatePositions();renderItems();requestAnimationFrame(animate)})();